<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>채팅방</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        .my-message {
            text-align: right;
            background-color: #DCF8C6;
            padding: 5px;
            border-radius: 5px;
            margin: 5px;
        }
        .other-message {
            text-align: left;
            background-color: #FFFFFF;
            padding: 5px;
            border-radius: 5px;
            margin: 5px;
        }
    </style>
</head>
<body>
<h1>채팅방</h1>
<div>
    <label>채팅방 ID: </label>
    <span id="roomId"></span>
</div>
<div id="chatLog" style="border:1px solid #ccc; padding:10px; width:300px; height:200px; overflow:auto;">
    채팅 기록
</div>
<div>
    <input type="text" id="message" placeholder="메시지 입력">
    <button onclick="sendMessage()">메시지 전송</button>
</div>
<script>
    let stompClient = null;
    let roomId = "";
    let currentUser = null;

    function getQueryParam(param) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(param);
    }

    function fetchCurrentUser() {
        fetch('http://localhost:8080/users/me', { credentials: 'include' })
            .then(response => {
                if (!response.ok) {
                    throw new Error("현재 사용자 정보를 가져오지 못했습니다.");
                }
                return response.json();
            })
            .then(data => {
                currentUser = data;
                connect();
            })
            .catch(error => {
                console.error("Error fetching current user:", error);
            });
    }

    function connect() {
        roomId = getQueryParam("roomId");
        document.getElementById("roomId").innerText = roomId;
        const socket = new SockJS('http://localhost:8080/ws-chat');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function(frame) {
            console.log('Connected: ' + frame);
            fetchChatHistory();
            stompClient.subscribe('/topic/chat/' + roomId, function(messageOutput) {
                showMessage(JSON.parse(messageOutput.body));
            });
        }, function(error) {
            console.error('STOMP 연결 실패: ' + error);
        });
    }

    function fetchChatHistory() {
        const sender = getQueryParam("member");
        // roomId 형식 "user1:user2"에서 현재 사용자가 아닌 상대를 추출
        const parts = roomId.split(":");
        let receiver = parts[0] === sender ? parts[1] : parts[0];
        fetch(`http://localhost:8080/history?sender=${encodeURIComponent(sender)}&receiver=${encodeURIComponent(receiver)}`, { credentials: 'include' })
            .then(response => {
                if (!response.ok) {
                    throw new Error("채팅 기록을 가져오지 못했습니다.");
                }
                return response.json();
            })
            .then(messages => {
                const chatLog = document.getElementById("chatLog");
                chatLog.innerHTML = "";
                messages.forEach(message => {
                    showMessage(message);
                });
            })
            .catch(error => {
                console.error("Error fetching chat history:", error);
            });
    }

    function sendMessage() {
        if (!currentUser) {
            alert("로그인 되어 있지 않습니다.");
            return;
        }
        const sender = currentUser.email;
        const parts = roomId.split(":");
        let receiver = parts[0] === sender ? parts[1] : parts[0];
        const content = document.getElementById("message").value;
        if (!content) {
            alert("메시지를 입력해주세요.");
            return;
        }
        const chatMessage = {
            sender: sender,
            receiver: receiver,
            content: content,
            fileUrl: ""
        };
        stompClient.send("/app/chat.send", {}, JSON.stringify(chatMessage));
        document.getElementById("message").value = "";
    }

    function showMessage(message) {
        const chatLog = document.getElementById("chatLog");
        const messageElement = document.createElement("p");
        messageElement.className = (message.sender === currentUser.email) ? "my-message" : "other-message";
        messageElement.innerText = "[" + message.timestamp + "] " + message.sender + ": " + message.content;
        chatLog.appendChild(messageElement);
    }

    fetchCurrentUser();
</script>
</body>
</html>
