<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>채팅방 목록</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        /* 채팅방 목록 스타일 */
        .chat-room {
            border: 1px solid #ccc;
            padding: 10px;
            margin: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<h1>채팅방 목록</h1>
<div>
    <label>현재 사용자: </label>
    <span id="currentUser"></span>
</div>
<div id="chatRoomsList">
    <!-- 채팅방 목록이 여기 표시됩니다. -->
</div>
<script>
    let currentUser = null;

    function fetchCurrentUser() {
        fetch('http://localhost:8080/users/me', { credentials: 'include' })
            .then(response => {
                if (!response.ok) {
                    throw new Error("현재 사용자 정보를 가져오지 못했습니다.");
                }
                return response.json();
            })
            .then(data => {
                currentUser = data; // 예: { id, email, name }
                document.getElementById("currentUser").innerText = currentUser.name + " (" + currentUser.email + ")";
                fetchChatRooms();
            })
            .catch(error => {
                console.error("Error fetching current user:", error);
            });
    }

    function fetchChatRooms() {
        if (!currentUser) return;
        // 여기서는 현재 사용자 식별자로 이메일을 사용한다고 가정합니다.
        fetch(`http://localhost:8080/rooms?member=${encodeURIComponent(currentUser.email)}`, { credentials: 'include' })
            .then(response => {
                if (!response.ok) {
                    throw new Error("채팅방 목록을 가져오지 못했습니다.");
                }
                return response.json();
            })
            .then(rooms => {
                const chatRoomsList = document.getElementById("chatRoomsList");
                chatRoomsList.innerHTML = "";
                rooms.forEach(room => {
                    const roomDiv = document.createElement("div");
                    roomDiv.className = "chat-room";
                    roomDiv.innerText = room.roomId;
                    roomDiv.onclick = function() {
                        // 채팅방 클릭 시 chatroom.html로 이동 (roomId와 현재 사용자를 쿼리파라미터로 전달)
                        window.location.href = `chatroom.html?roomId=${encodeURIComponent(room.roomId)}&member=${encodeURIComponent(currentUser.email)}`;
                    };
                    chatRoomsList.appendChild(roomDiv);
                });
            })
            .catch(error => {
                console.error("Error fetching chat rooms:", error);
            });
    }

    fetchCurrentUser();
</script>
</body>
</html>
